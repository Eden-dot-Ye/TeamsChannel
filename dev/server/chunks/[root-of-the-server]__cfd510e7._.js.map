{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Data/Project/TeamsChannel/code/app/api/categorize/route.ts"],"sourcesContent":["import { AzureOpenAI } from 'openai'\nimport { z } from 'zod'\nimport { NextResponse } from 'next/server' // 推荐使用 NextResponse\n\n// 1. 把 Client 变量放在外面，但不要初始化\nlet client: AzureOpenAI | null = null;\n\nconst categorySchema = z.object({\n  categoryId: z.string().describe('The ID of the most appropriate category'),\n  confidence: z.number().min(0).max(1).describe('Confidence score between 0 and 1'),\n  reasoning: z.string().describe('Brief explanation for the categorization'),\n})\n\n// 2. 这里的 Log 可能会在编译时出现，运行时不一定每次都出\nconsole.log('[v0] Route file loaded') \n\nexport async function POST(req: Request) {\n  console.log('[v0] API POST request received'); // 这一行现在应该能看到了\n\n  try {\n    // 3. 在函数内部检查环境变量\n    const apiKey = process.env.AZURE_OPENAI_API_KEY;\n    const endpoint = process.env.AZURE_OPENAI_ENDPOINT;\n    const apiVersion = process.env.AZURE_OPENAI_API_VERSION;\n    const deployment = process.env.AZURE_OPENAI_DEPLOYMENT_NAME;\n\n    // 4. 安全检查：如果有变量缺失，显式抛出错误，而不是让 Node 进程崩溃\n    if (!apiKey || !endpoint || !apiVersion || !deployment) {\n      console.error('[v0] Missing Azure OpenAI Environment Variables:', {\n        hasKey: !!apiKey,\n        hasEndpoint: !!endpoint,\n        hasVersion: !!apiVersion,\n        hasDeployment: !!deployment\n      });\n      return NextResponse.json(\n        { error: 'Server configuration error: Missing Azure environment variables' },\n        { status: 500 }\n      );\n    }\n\n    // 5. 延迟初始化 Client (单例模式)\n    if (!client) {\n      client = new AzureOpenAI({\n        endpoint,\n        apiKey,\n        deployment,\n        apiVersion,\n        dangerouslyAllowBrowser: true,\n      });\n    }\n\n    const { message, categories } = await req.json()\n\n    console.log('[v0] Categories received:', categories)\n\n    const categoriesText = categories\n      .map((cat: any) => `${cat.id}: ${cat.name}${cat.description ? ' - ' + cat.description : ''}`)\n      .join('\\n')\n\n    const prompt = `You are an AI assistant that categorizes messages in a team communication platform.\n\nAvailable categories:\n${categoriesText}\n\nMessage to categorize:\n\"${message}\"\n\nAnalyze the message and determine which category best fits. Consider the content, intent, and tone of the message.\n\nRespond with a JSON object matching this schema:\n{\n  \"categoryId\": \"string (The ID of the most appropriate category)\",\n  \"confidence\": \"number between 0 and 1\",\n  \"reasoning\": \"string (Brief explanation for the categorization)\"\n}`\n\n    console.log('[v0] Calling Azure OpenAI with deployment:', deployment)\n\n    console.log('[v0] Azure OpenAI response start 2')\n\n    // 注意：这里的 model 参数在 Azure 中通常对应 deployment name\n    const completion = await client.chat.completions.create({\n      model: deployment, \n      messages: [\n        {\n          role: 'system',\n          content: 'You are an AI assistant that categorizes messages. Always respond with valid JSON.',\n        },\n        {\n          role: 'user',\n          content: prompt,\n        },\n      ],\n      max_completion_tokens: 500,\n    })\n\n    console.log('[v0] Azure OpenAI response received')\n    \n    // ... (后续解析逻辑保持不变) ...\n    \n    const content = completion.choices[0].message.content\n    if (!content) throw new Error('No content in response')\n\n    const parsed = JSON.parse(content)\n    console.log('[v0] Categorization result:', parsed)\n\n    const object = categorySchema.parse(parsed)\n\n    return NextResponse.json(object)\n\n  } catch (error: any) {\n    // 6. 详细打印错误\n    console.error('[v0] Error detail:', error);\n    \n    // 如果是 OpenAI 的特定错误，打印更多信息\n    if (error.response) {\n       console.error(error.response.status);\n       console.error(error.response.data);\n    }\n\n    return NextResponse.json(\n      { error: 'Failed to categorize message', details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AACA,kOAA2C,oBAAoB;;;;AAE/D,4BAA4B;AAC5B,IAAI,SAA6B;AAEjC,MAAM,iBAAiB,yKAAC,CAAC,MAAM,CAAC;IAC9B,YAAY,yKAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAChC,YAAY,yKAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,GAAG,QAAQ,CAAC;IAC9C,WAAW,yKAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;AACjC;AAEA,kCAAkC;AAClC,QAAQ,GAAG,CAAC;AAEL,eAAe,KAAK,GAAY;IACrC,QAAQ,GAAG,CAAC,mCAAmC,cAAc;IAE7D,IAAI;QACF,iBAAiB;QACjB,MAAM,SAAS,QAAQ,GAAG,CAAC,oBAAoB;QAC/C,MAAM,WAAW,QAAQ,GAAG,CAAC,qBAAqB;QAClD,MAAM,aAAa,QAAQ,GAAG,CAAC,wBAAwB;QACvD,MAAM,aAAa,QAAQ,GAAG,CAAC,4BAA4B;QAE3D,wCAAwC;QACxC,IAAI,CAAC,UAAU,CAAC,YAAY,CAAC,cAAc,CAAC,YAAY;YACtD,QAAQ,KAAK,CAAC,oDAAoD;gBAChE,QAAQ,CAAC,CAAC;gBACV,aAAa,CAAC,CAAC;gBACf,YAAY,CAAC,CAAC;gBACd,eAAe,CAAC,CAAC;YACnB;YACA,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAkE,GAC3E;gBAAE,QAAQ;YAAI;QAElB;QAEA,yBAAyB;QACzB,IAAI,CAAC,QAAQ;YACX,SAAS,IAAI,iJAAW,CAAC;gBACvB;gBACA;gBACA;gBACA;gBACA,yBAAyB;YAC3B;QACF;QAEA,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG,MAAM,IAAI,IAAI;QAE9C,QAAQ,GAAG,CAAC,6BAA6B;QAEzC,MAAM,iBAAiB,WACpB,GAAG,CAAC,CAAC,MAAa,GAAG,IAAI,EAAE,CAAC,EAAE,EAAE,IAAI,IAAI,GAAG,IAAI,WAAW,GAAG,QAAQ,IAAI,WAAW,GAAG,IAAI,EAC3F,IAAI,CAAC;QAER,MAAM,SAAS,CAAC;;;AAGpB,EAAE,eAAe;;;CAGhB,EAAE,QAAQ;;;;;;;;;CASV,CAAC;QAEE,QAAQ,GAAG,CAAC,8CAA8C;QAE1D,QAAQ,GAAG,CAAC;QAEZ,+CAA+C;QAC/C,MAAM,aAAa,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACtD,OAAO;YACP,UAAU;gBACR;oBACE,MAAM;oBACN,SAAS;gBACX;gBACA;oBACE,MAAM;oBACN,SAAS;gBACX;aACD;YACD,uBAAuB;QACzB;QAEA,QAAQ,GAAG,CAAC;QAEZ,uBAAuB;QAEvB,MAAM,UAAU,WAAW,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO;QACrD,IAAI,CAAC,SAAS,MAAM,IAAI,MAAM;QAE9B,MAAM,SAAS,KAAK,KAAK,CAAC;QAC1B,QAAQ,GAAG,CAAC,+BAA+B;QAE3C,MAAM,SAAS,eAAe,KAAK,CAAC;QAEpC,OAAO,gJAAY,CAAC,IAAI,CAAC;IAE3B,EAAE,OAAO,OAAY;QACnB,YAAY;QACZ,QAAQ,KAAK,CAAC,sBAAsB;QAEpC,0BAA0B;QAC1B,IAAI,MAAM,QAAQ,EAAE;YACjB,QAAQ,KAAK,CAAC,MAAM,QAAQ,CAAC,MAAM;YACnC,QAAQ,KAAK,CAAC,MAAM,QAAQ,CAAC,IAAI;QACpC;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAgC,SAAS,MAAM,OAAO;QAAC,GAChE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}